<!DOCTYPE html>

<meta charset=utf-8>
<title>Timeline</title>
<link rel=stylesheet href=../backup.css>

<body class=post>

<article class=regular id=p-10237031224>
<p class=meta><span class=date>15/09/2011 21:45:00</span>
<a class=llink href=../posts/10237031224.html>¶</a>
<a href=http://www.ahwkong.com/post/10237031224 rel=canonical>●</a></p>
<h2>Use of java.util.concurrent.Executor stops tomcat from stopping</h2>
I need to use <code>java.util.concurrent.Executor</code> to serialize the execution of some legacy code inside a WebService.

I have added an member variable, executor, to the <code>WebService</code> class. It is injected from the outside by the springframework.

The executor bean is defined as such:

<pre>
&lt;bean id="riskValueEstimateUpdateExecutor" scope="singleton"
        class="java.util.concurrent.Executors"
        factory-method="newSingleThreadExecutor" /&gt;
</pre>

<b>Problem:</b>

The WS works as expected. We rolled it out to a linux server. Then we realised the tomcat stop script could no longer stop the service.

I sent <code>kill -3</code> to the tomcat instance. In the thread dump I find these lines:

<pre>
"pool-2-thread-1" prio=10 tid=0xad637c00 nid=0xf37 waiting on condition [0xae882000..0xae883020]
   java.lang.Thread.State: WAITING (parking)
        at sun.misc.Unsafe.park(Native Method)
        - parking to wait for   (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
        at java.util.concurrent.locks.LockSupport.park(LockSupport.java:158)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1925)
        at java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:358)
        at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:946)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:906)
        at java.lang.Thread.run(Thread.java:619)
</pre>

To fix this, I need to tell Spring framework how to shut down the executor

<pre>
&lt;bean id="riskValueEstimateUpdateExecutor" scope="singleton"
        destroy-method="shutdown"
        class="java.util.concurrent.Executors"
        factory-method="newSingleThreadExecutor" /&gt;
</pre>

<a href="http://stackoverflow.com/questions/7427132/use-of-java-util-concurrent-executor-stops-tomcat-from-stopping">Originally asked on SO</a>

<p></p>
<b>Version information:</b>

* Tomcat version: 6.0.22
* Java version: 1.6
* spring framework: 2.5.5
</article>
